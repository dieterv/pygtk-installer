<?xml version="1.0" encoding="utf-8"?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
    <?define Platform               = "XXX"?>
    <?define PythonVersion          = "XXX"?>
    <?define ProductVersion         = "XXX"?>
    <?define SrcImages              = "XXX"?>
    <?define Manufacturer           = "http://www.pygtk.org/"?>
    <?define ManufacturerContact    = "http://www.pygtk.org/feedback.html"?>
    <?define OriginalProductVersion = "2.0.0"?>

    <?if $(var.Platform) = "x86"?>
        <?define ProductName = "Python $(var.PythonVersion) PyGtk $(var.ProductVersion)"?>
        <?define Win64 = "no"?>
        <?if $(var.PythonVersion) = "2.6"?>
            <?define UpgradeCode = "{67D26C03-D5BD-4549-9FEA-76F9B8171584}"?>
        <?elseif $(var.PythonVersion) = "2.7"?>
            <?define UpgradeCode = "{7E8DD188-EB7F-46FC-8E39-64A92D227927}"?>
        <?else?>
            <?error Unknown Python version specified: $(var.PythonVersion)?>
        <?endif?>
    <?elseif $(var.Platform) = "x64"?>
        <?define ProductName = "Python $(var.PythonVersion) PyGtk $(var.ProductVersion) (64 bit)"?>
        <?define Win64 = "yes"?>
        <?if $(var.PythonVersion) = "2.6"?>
            <?define UpgradeCode = "{65A7410A-6B75-4A97-9C3A-3450BB65615E}"?>
        <?elseif $(var.PythonVersion) = "2.7"?>
            <?define UpgradeCode = "{2CC0DCE7-E4BD-48E2-823E-CBFF1D92E560}"?>
        <?else?>
            <?error Unknown Python version specified: $(var.PythonVersion)?>
        <?endif?>
    <?else?>
        <?error Unknown Platform specified: $(var.Platform)?>
    <?endif?>

    <Product Id="*"
             Language="1033"
             Manufacturer="$(var.Manufacturer)"
             Name="$(var.ProductName)"
             UpgradeCode="$(var.UpgradeCode)"
             Version="$(var.ProductVersion)">

        <Package Id="*"
                 AdminImage="no"
                 Comments="$(var.ProductName) Windows Installer Database"
                 Compressed="yes"
                 Description="$(var.ProductName)"
                 InstallerVersion="200"
                 Keywords="Installer,MSI,Database"
                 Languages="1033"
                 Manufacturer="$(var.Manufacturer)"
                 Platform="$(var.Platform)"
                 ReadOnly="yes" />

        <Condition Message="$(var.ProductName) is only supported on Windows 2000 and above.">
            <![CDATA[NOT VersionNT < 500]]>
        </Condition>

        <Upgrade Id="$(var.UpgradeCode)">
            <UpgradeVersion Minimum="$(var.ProductVersion)"
                            IncludeMinimum="no"
                            OnlyDetect="yes"
                            Language="1033"
                            Property="DOWNGRADEFOUND" />

            <UpgradeVersion Minimum="$(var.OriginalProductVersion)"
                            IncludeMinimum="yes"
                            Maximum="$(var.ProductVersion)"
                            IncludeMaximum="no"
                            Language="1033"
                            Property="UPGRADEFOUND" />
        </Upgrade>

        <Media Id="1"
               Cabinet="distfiles"
               CompressionLevel="high"
               EmbedCab="yes" />

        <?include WixUI_PyGTK.wxs?>
        <UIRef Id="WixUI_PyGTK" />
        <WixVariable Id="WixUIBannerBmp" Value="$(var.SrcImages)/PyGtkBanner.jpg" />
        <WixVariable Id="WixUIDialogBmp" Value="$(var.SrcImages)/PyGtkDialog.jpg" />
        <WixVariable Id="WixUIExclamationIco" Value="$(var.SrcImages)/PyGtkExclamationIco.ico" />
        <WixVariable Id="WixUIInfoIco" Value="$(var.SrcImages)/PyGtkInfoIco.ico" />
        <WixVariable Id="WixUINewIco" Value="$(var.SrcImages)/PyGtkNewIco.ico" />
        <WixVariable Id="WixUIUpIco" Value="$(var.SrcImages)/PyGtkUpIco.ico" />

        <Icon Id="PyGtkIcon" SourceFile="$(var.SrcImages)/PyGtkIcon.ico" />
        <Property Id="ARPPRODUCTICON" Value="PyGtkIcon" />

        <Property Id="PYTHON.MACHINE">
            <RegistrySearch Id="PYTHON.MACHINE" Root="HKLM" Key="SOFTWARE\Python\PythonCore\$(var.PythonVersion)\InstallPath" Type="raw" />
        </Property>
        <Property Id="PYTHON.USER">
            <RegistrySearch Id="PYTHON.USER" Root="HKCU" Key="SOFTWARE\Python\PythonCore\$(var.PythonVersion)\InstallPath" Type="raw" />
        </Property>

        <CustomAction Id="PreventDowngrading" Error="A newer version of $(var.ProductName) is already installed." />
        <CustomAction Id="AllUsersFromParam" Property="AllUsersFromParam" Value="[ALLUSERS]" Execute="firstSequence" />
        <CustomAction Id="TargetDirFromParam" Property="TargetDirFromParam" Value="[TARGETDIR]" Execute="firstSequence" />
        <CustomAction Id="PythonX" Property="PythonDir" Value="[WindowsVolume]PythonX" Execute="firstSequence" />
        <CustomAction Id="PythonFromMachine" Property="PythonDir" Value="[PYTHON.MACHINE]" Execute="firstSequence" />
        <CustomAction Id="PythonFromUser" Property="PythonDir" Value="[PYTHON.USER]" Execute="firstSequence" />
        <CustomAction Id="PythonDetected" Property="PythonDetected" Value="1" Execute="firstSequence" />
        <CustomAction Id="InitialTargetDir" Property="TARGETDIR" Value="[PythonDir]" Execute="firstSequence" />
        <CustomAction Id="InstallForJustMe" Property="ALLUSERS" Value="{}" Execute="firstSequence" />
        <CustomAction Id="InstallForEveryone" Property="ALLUSERS" Value="1" Execute="firstSequence" />

        <InstallExecuteSequence>
            <Custom Action="PreventDowngrading" Sequence="201">DOWNGRADEFOUND</Custom>
            <Custom Action="AllUsersFromParam" Sequence="401" />
            <Custom Action="TargetDirFromParam" Sequence="402" />
            <Custom Action="PythonX" Sequence="403">NOT TargetDirFromParam</Custom>
            <Custom Action="PythonFromMachine" Sequence="404">PYTHON.MACHINE AND NOT AllUsersFromParam AND NOT TargetDirFromParam</Custom>
            <Custom Action="InstallForEveryone" Sequence="405">PYTHON.MACHINE AND NOT AllUsersFromParam AND NOT TargetDirFromParam</Custom>
            <Custom Action="PythonFromUser" Sequence="406">PYTHON.USER AND NOT AllUsersFromParam AND NOT TargetDirFromParam</Custom>
            <Custom Action="InstallForJustMe" Sequence="407">PYTHON.USER AND NOT AllUsersFromParam AND NOT TargetDirFromParam</Custom>
            <Custom Action="PythonDetected" Sequence="408">(PYTHON.MACHINE OR PYTHON.USER) AND NOT AllUsersFromParam AND NOT TargetDirFromParam</Custom>
            <Custom Action="InitialTargetDir" Sequence="409">NOT TargetDirFromParam</Custom>
            <RemoveExistingProducts Sequence="1401" />
        </InstallExecuteSequence>

        <InstallUISequence>
            <Custom Action="PreventDowngrading" Sequence="201">DOWNGRADEFOUND</Custom>
            <Custom Action="AllUsersFromParam" Sequence="401" />
            <Custom Action="TargetDirFromParam" Sequence="402" />
            <Custom Action="PythonX" Sequence="403">NOT TargetDirFromParam</Custom>
            <Custom Action="PythonFromMachine" Sequence="404">PYTHON.MACHINE AND NOT AllUsersFromParam AND NOT TargetDirFromParam</Custom>
            <Custom Action="InstallForEveryone" Sequence="405">PYTHON.MACHINE AND NOT AllUsersFromParam AND NOT TargetDirFromParam</Custom>
            <Custom Action="PythonFromUser" Sequence="406">PYTHON.USER AND NOT AllUsersFromParam AND NOT TargetDirFromParam</Custom>
            <Custom Action="InstallForJustMe" Sequence="407">PYTHON.USER AND NOT AllUsersFromParam AND NOT TargetDirFromParam</Custom>
            <Custom Action="PythonDetected" Sequence="408">(PYTHON.MACHINE OR PYTHON.USER) AND NOT AllUsersFromParam AND NOT TargetDirFromParam</Custom>
            <Custom Action="InitialTargetDir" Sequence="409">NOT TargetDirFromParam</Custom>
        </InstallUISequence>

        <Feature Id="PyGTKAllInOne"
                 Title="PyGTK All-in-one"
                 Description="Installs everything you need for PyGTK development except a Python $(var.PythonVersion) interpreter."
                 ConfigurableDirectory="TARGETDIR"
                 Absent="disallow"
                 Display="expand"
                 Level="1"
                 AllowAdvertise="no"
                 InstallDefault="local">
            <ComponentRef Id="Empty" />
        </Feature>

        <Directory Id="TARGETDIR" Name="SourceDir">
            <!-- Referenced by container Features -->
            <Component Id="Empty" KeyPath="yes" Guid="{2957BDC1-E807-49fb-A46D-F70834B326C4}">
                <CreateFolder />
            </Component>
        </Directory>
    </Product>
</Wix>
